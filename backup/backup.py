#!/usr/bin/env python3import osimport datetimeimport shutilimport tarfileimport gzipfrom ftplib import FTP# Handle Configfrom backup_config import CONFIGHOST = CONFIG['host']USER = CONFIG['user']PASSWD = CONFIG['passwd']LOG_PATH = CONFIG['log']LOG_FORMAT = CONFIG['format']KEEP = CONFIG['keep']def dt():    """    Returns a current datetime string    :return: String representing .now().    """    return datetime.datetime.now().strftime(LOG_FORMAT)def log(msg, path):    """    Logs the given message to the given log file, appending the current datetime.    :param msg: Message to put in log file    :param path: Path to log file    :return: Nothing    """    with open(path, 'a') as log_file:        log_file.write('{0} - {1}\n'.format(dt(), msg))def get_dt(fn):    """    Gets a datetime object form the given filename    :param fn: A filename with an appended date generated by this script file    :return: Datetime object    """    return datetime.datetime.strptime(fn[:19], LOG_FORMAT)def sort(x, lis):    """    Check to see if the dated filename is newer than any of the dated filenames    in the given list and if so, replace the first item in the list that it is bigger than.    :param x: Dated filename to check.    :param lis: List of dated filenames to compare against x    :return: True if x added to keep list, else None    """    for i, y in enumerate(lis):        if get_dt(x) > get_dt(y):            lis[i] = x            return Truedef clean(files, num):    """    Deletes all but the given number of the newest files.    :param files: A list of file names    :param num: Maximum number of iterations    :return: List of files to delete    """    # First see if any cleaning needs to be done.    if len(files) <= num:        return []    log('Cleaning old files', LOG_PATH)    # Generate a list of filenames to keep.    keep = files[:num]    for x in files:        sort(x, keep)    log('Keeping: {0}'.format(keep), LOG_PATH)    # Subtract and return list of files to keep from list of all files.    return list(set(files) - set(keep))log('Script started', LOG_PATH)# Prepare file for backup and append the current DateTime to the files.dt_file = dt()filename_tar = '{0}__dbdata.tar'.format(dt_file)filename = '{0}__dbdata.gz'.format(dt_file)db = '/data/db'# Make an archive (tar file).with tarfile.open(filename_tar, 'w') as tar:    tar.add(db)    log('Archive ({0}) created'.format(filename_tar), LOG_PATH)# Put the archive in a compressed file (gzip).with open(filename_tar, 'rb') as f_in, gzip.open(filename, 'wb') as f_out:    shutil.copyfileobj(f_in, f_out)    log('Archive ({0}) moved to compressed file ({1})'.format(filename_tar, filename), LOG_PATH)# Delete the archive.os.remove(filename_tar)log('Archive ({0}) deleted'.format(filename_tar), LOG_PATH)# Send file to FTP server.log('Connecting to host ({0})...'.format(CONFIG['host']), LOG_PATH)with FTP(host=HOST, user=USER, passwd=PASSWD) as ftp:    log('Connected to host ({0}).'.format(CONFIG['host']), LOG_PATH)    with open(filename, 'rb') as archive:        log('Compressed file uploading ({0})...'.format(filename), LOG_PATH)        ftp.storbinary('STOR ' + filename, archive)        log('Compressed file uploaded.', LOG_PATH)    # Cleans the FTP folder of old files    files_delete = clean([i[0] for i in ftp.mlsd()], KEEP)    for file in files_delete:        log('Deleting old file ({0})'.format(file), LOG_PATH)        ftp.delete(file)    ftp.quit()# Delete the compressed file.os.remove(filename)log('Compressed file ({0}) deleted'.format(filename), LOG_PATH)log('Script finished', LOG_PATH)